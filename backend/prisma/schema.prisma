generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// Enums
enum PatientStatus {
  recovered
  awaiting_surgery
  on_treatment
}

enum AppointmentStatus {
  pending
  confirmation_required
  confirmed
}

enum AppointmentType {
  first_time
  follow_up
}

enum Sex {
  male
  female
}

model RefreshToken {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  tokenHash       String    @unique
  expiresAt       DateTime
  createdAt       DateTime  @default(now())
  replacedByToken String?
  revokedAt       DateTime?
  revokedByIp     String?
  // Relations
  userId          String    @db.ObjectId
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model User {
  id       String  @id @default(auto()) @map("_id") @db.ObjectId
  email    String  @unique
  password String?
  userName String

  name          String? 
  specialty     String?
  companyName   String?
  industry      String?
  employeeCount String?
  avatar        String?
  phoneNumber   String?
  bio           String?
  address       String?
  hasCompletedOnboarding Boolean @default(false)
  googleId      String?
  isVerified    Boolean   @default(false)
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? 
  emailVerifications EmailVerification[]
  passwordResets     PasswordReset[]
  refreshTokens      RefreshToken[]
  appointments       Appointment[]
  tasks              Task[]
  patients           Patient[]
  notifications      Notification[]

  @@index([googleId])
  @@index([isVerified, isActive])
  @@map("users")
}

model Notification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  title     String  
  message   String   
  type      String   
  isRead    Boolean  @default(false)
  link      String?  
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notifications")
}


model EmailVerification {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  userId    String    @db.ObjectId
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  hashedOtp String
  expiresAt DateTime
  attempts  Int       @default(0) // Track wrong attempts
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([userId, expiresAt])
  @@index([hashedOtp])
  @@map("email_verifications")
}

model PasswordReset {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  userId      String    @db.ObjectId
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  hashedToken String    @unique
  expiresAt   DateTime
  usedAt      DateTime?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId, expiresAt])
  @@map("password_resets")
}

model Patient {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  recordNumber String        @unique
  forename     String
  surname      String
  dateOfBirth  DateTime
  sex          Sex
  diagnosis    String
  notes        String?
  phoneNumber  String
  status       PatientStatus @default(on_treatment)
   
  userId       String        @db.ObjectId
  user         User          @relation(fields: [userId], references: [id])
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  deletedAt    DateTime? // Soft delete

  appointments Appointment[]

  @@index([surname, forename])
  @@index([status])
  @@map("patients")
}

model Appointment {
  id            String            @id @default(auto()) @map("_id") @db.ObjectId
  userId        String            @db.ObjectId
  patientId     String            @db.ObjectId
  startTime     DateTime
  endTime       DateTime?
  date          DateTime?
  time          String?
  clinic        String?
  room          String?
  location      String?
  purpose       String?
  status        AppointmentStatus @default(pending)
  duration      Int
  type          AppointmentType
  isOnline      Boolean           @default(false)
  notifications Boolean           @default(false)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  user    User    @relation(fields: [userId], references: [id])
  patient Patient @relation(fields: [patientId], references: [id])
}

model Task {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  userId      String    @db.ObjectId
  title       String
  description String?
  date        DateTime?
  isCompleted Boolean   @default(false)
  status      Boolean?
  statusText  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id])
}
